<div class="sales-plan-container">
  <div class="header">
    <h1>Planes de ventas</h1>
    <div class="breadcrumb">
      <span class="breadcrumb-link">Ventas</span>
      <span class="breadcrumb-separator">-</span>
      <span class="breadcrumb-current">Planes de ventas</span>
    </div>
  </div>

  <div class="table-container">
    <div class="action-bar">
      <button
        mat-raised-button
        class="create-btn"
        aria-label="Crear plan de ventas"
      >
        Crear plan de ventas
      </button>
    </div>

    @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando planes de ventas...</p>
    </div>
    } @else {

    <div class="filter-row">
      <input
        type="text"
        class="filter-input"
        placeholder="Buscar nombre"
        [(ngModel)]="nameFilter"
        (input)="onFilterChange()"
        aria-label="Filtrar por nombre"
        style="width: 290px;"
      />

      <input
        type="text"
        class="filter-input"
        placeholder="Buscar fecha inicio"
        [(ngModel)]="startDateFilter"
        (input)="onFilterChange()"
        aria-label="Filtrar por fecha de inicio"
        style="width: 172px;"
      />

      <input
        type="text"
        class="filter-input"
        placeholder="Buscar fecha fin"
        [(ngModel)]="endDateFilter"
        (input)="onFilterChange()"
        aria-label="Filtrar por fecha de fin"
        style="width: 172px;"
      />

      <input
        type="text"
        class="filter-input"
        placeholder="Buscar cliente"
        [(ngModel)]="clientFilter"
        (input)="onFilterChange()"
        aria-label="Filtrar por cliente"
        style="width: 292px;"
      />
    </div>

    <table mat-table [dataSource]="salesPlans()" class="sales-plan-table">
      <!-- Nombre Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>NOMBRE</th>
        <td mat-cell *matCellDef="let plan">{{ plan.name }}</td>
      </ng-container>

      <!-- Fecha de inicio Column -->
      <ng-container matColumnDef="start_date">
        <th mat-header-cell *matHeaderCellDef>FECHA DE INICIO</th>
        <td mat-cell *matCellDef="let plan">
          {{ formatDate(plan.start_date) }}
        </td>
      </ng-container>

      <!-- Fecha de fin Column -->
      <ng-container matColumnDef="end_date">
        <th mat-header-cell *matHeaderCellDef>FECHA DE FIN</th>
        <td mat-cell *matCellDef="let plan">
          {{ formatDate(plan.end_date) }}
        </td>
      </ng-container>

      <!-- Cliente Column -->
      <ng-container matColumnDef="client_id">
        <th mat-header-cell *matHeaderCellDef>CLIENTE</th>
        <td mat-cell *matCellDef="let plan">{{ plan.client_name }}</td>
      </ng-container>

      <!-- Acciones Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>ACCIONES</th>
        <td mat-cell *matCellDef="let plan">
          <button
            mat-icon-button
            (click)="openDetail(plan)"
            class="action-btn view-btn"
            aria-label="Ver detalle del plan"
          >
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No data row -->
      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          No se encontraron planes con los filtros aplicados.
        </td>
      </tr>
    </table>

    <!-- Pagination -->
    @if (pagination() && pagination()!.total_pages > 1) {
    <div class="custom-pagination">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }} al
        {{
          Math.min(
            currentPage * pageSize,
            pagination()!.total
          )
        }}
        de {{ pagination()!.total }} registros
      </div>

      <div class="pagination-buttons">
        <button
          class="pagination-btn"
          (click)="goToPage(currentPage - 1)"
          [disabled]="currentPage === 1"
          aria-label="Página anterior"
        >
          Anterior
        </button>

        @for (page of getPages(); track page) { @if (page > 0) {
        <button
          class="pagination-btn"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
          [attr.aria-label]="'Ir a página ' + page"
          [attr.aria-current]="page === currentPage ? 'page' : null"
        >
          {{ page }}
        </button>
        } @else {
        <span class="pagination-ellipsis" aria-hidden="true">...</span>
        } }

        <button
          class="pagination-btn"
          (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === pagination()!.total_pages"
          aria-label="Página siguiente"
        >
          Siguiente
        </button>
      </div>
    </div>
    } }
  </div>
</div>
