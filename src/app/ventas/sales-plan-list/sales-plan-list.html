<div class="sales-plan-container">
  <div class="header">
    <h1 i18n="@@salesPlans.title">Planes de ventas</h1>
    <div class="breadcrumb">
      <span class="breadcrumb-link" i18n="@@salesPlans.breadcrumbSales">Ventas</span>
      <span class="breadcrumb-separator">-</span>
      <span class="breadcrumb-current" i18n="@@salesPlans.breadcrumbSalesPlans">Planes de ventas</span>
    </div>
  </div>

  <div class="table-container">
    <div class="action-bar">
      <button
        mat-raised-button
        class="create-btn"
        i18n-aria-label="@@salesPlans.createPlan"
        aria-label="Crear plan de ventas"
        (click)="openCreate()"
      >
        <span i18n="@@salesPlans.createPlan">Crear plan de ventas</span>
      </button>
    </div>

    @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p i18n="@@salesPlans.loading">Cargando planes de ventas...</p>
    </div>
    } @else {

    <table mat-table [dataSource]="salesPlans()" class="sales-plan-table">
      <!-- Nombre Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>
          <span i18n="@@salesPlans.name">NOMBRE</span>
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              i18n-placeholder="@@salesPlans.searchName"
              placeholder="Buscar nombre"
              [(ngModel)]="nameFilter"
              (input)="onFilterChange()"
              i18n-aria-label="@@salesPlans.filterByName"
              aria-label="Filtrar por nombre" />
          </div>
        </th>
        <td mat-cell *matCellDef="let plan">{{ plan.name }}</td>
      </ng-container>

      <!-- Fecha de inicio Column -->
      <ng-container matColumnDef="start_date">
        <th mat-header-cell *matHeaderCellDef>
          <span i18n="@@salesPlans.startDate">FECHA DE INICIO</span>
          <div class="filter-header">
            <input
              type="date"
              class="filter-input"
              i18n-placeholder="@@salesPlans.searchStartDate"
              placeholder="Buscar fecha inicio"
              [ngModel]="startDateFilter"
              (ngModelChange)="onStartDateChange($event)"
              i18n-aria-label="@@salesPlans.filterByStartDate"
              aria-label="Filtrar por fecha de inicio" />
          </div>
        </th>
        <td mat-cell *matCellDef="let plan">
          {{ formatDate(plan.start_date) }}
        </td>
      </ng-container>

      <!-- Fecha de fin Column -->
      <ng-container matColumnDef="end_date">
        <th mat-header-cell *matHeaderCellDef>
          <span i18n="@@salesPlans.endDate">FECHA DE FIN</span>
          <div class="filter-header">
            <input
              type="date"
              class="filter-input"
              i18n-placeholder="@@salesPlans.searchEndDate"
              placeholder="Buscar fecha fin"
              [ngModel]="endDateFilter"
              (ngModelChange)="onEndDateChange($event)"
              i18n-aria-label="@@salesPlans.filterByEndDate"
              aria-label="Filtrar por fecha de fin" />
          </div>
        </th>
        <td mat-cell *matCellDef="let plan">
          {{ formatDate(plan.end_date) }}
        </td>
      </ng-container>

      <!-- Cliente Column -->
      <ng-container matColumnDef="client_id">
        <th mat-header-cell *matHeaderCellDef>
          <span i18n="@@salesPlans.client">CLIENTE</span>
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              i18n-placeholder="@@salesPlans.searchClient"
              placeholder="Buscar cliente"
              [(ngModel)]="clientFilter"
              (input)="onFilterChange()"
              i18n-aria-label="@@salesPlans.filterByClient"
              aria-label="Filtrar por cliente" />
          </div>
        </th>
        <td mat-cell *matCellDef="let plan">{{ plan.client_name }}</td>
      </ng-container>

      <!-- Acciones Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef><span i18n="@@salesPlans.actions">ACCIONES</span></th>
        <td mat-cell *matCellDef="let plan">
          <button
            mat-icon-button
            (click)="openDetail(plan)"
            class="action-btn view-btn"
            i18n-aria-label="@@salesPlans.viewDetail"
            aria-label="Ver detalle del plan"
          >
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No data row -->
      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          <span i18n="@@salesPlans.noData">No se encontraron planes con los filtros aplicados.</span>
        </td>
      </tr>
    </table>

    <!-- Pagination -->
    @if (pagination() && pagination()!.total_pages > 1) {
    <div class="custom-pagination">
      <div class="pagination-info">
        <ng-container i18n="@@salesPlans.paginationInfo">Mostrando {{ (currentPage - 1) * pageSize + 1 }} al {{ Math.min(currentPage * pageSize, pagination()!.total) }} de {{ pagination()!.total }} registros</ng-container>
      </div>

      <div class="pagination-buttons">
        <button
          class="pagination-btn"
          (click)="goToPage(currentPage - 1)"
          [disabled]="currentPage === 1"
          i18n-aria-label="@@salesPlans.previousPage"
          aria-label="Página anterior"
        >
          <span i18n="@@salesPlans.previous">Anterior</span>
        </button>

        @for (page of getPages(); track page) { @if (page > 0) {
        <button
          class="pagination-btn"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
          [attr.aria-label]="'Ir a página ' + page"
          [attr.aria-current]="page === currentPage ? 'page' : null"
        >
          {{ page }}
        </button>
        } @else {
        <span class="pagination-ellipsis" aria-hidden="true">...</span>
        } }

        <button
          class="pagination-btn"
          (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === pagination()!.total_pages"
          i18n-aria-label="@@salesPlans.nextPage"
          aria-label="Página siguiente"
        >
          <span i18n="@@salesPlans.next">Siguiente</span>
        </button>
      </div>
    </div>
    } }
  </div>
</div>
