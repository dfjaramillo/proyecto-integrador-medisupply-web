<div class="seller-reports-container">
  <!-- Header -->
  <div class="header">
    <h1 i18n="@@reports.seller.title">Informe de vendedores</h1>
    <div class="breadcrumb">
      <span class="breadcrumb-link" i18n="@@reports.seller.breadcrumbSales">Ventas</span>
      <span class="breadcrumb-separator">-</span>
      <span class="breadcrumb-current" i18n="@@reports.seller.breadcrumbCurrent">Informe de vendedores</span>
    </div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Seller Selection -->
    @if (currentUserRole() === 'Administrador') {
      <div class="selector-container">
        <mat-form-field appearance="outline" class="seller-selector">
          <mat-label i18n="@@reports.seller.sellerLabel">Vendedor</mat-label>
          <mat-select 
            [(ngModel)]="selectedSellerId" 
            (selectionChange)="onSellerChange()"
            [disabled]="loadingSellers()">
            <mat-option *ngFor="let seller of sellers()" [value]="seller.id">
              {{ seller.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    }

    <!-- Loading State -->
    @if (loadingReports()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p i18n="@@reports.seller.loadingReports">Cargando informes...</p>
      </div>
    }

    <!-- Reports Section (only shown when seller is selected and not loading) -->
    @if (selectedSellerId() && !loadingReports() && statusSummary()) {
      <!-- Top Row: Donut Chart and Earnings Table -->
      <div class="top-row">
        <!-- Donut Chart -->
        <div class="chart-card donut-chart-card">
          <h2 class="card-title" i18n="@@reports.seller.distributionTitle">Distribución pedidos hechos por los clientes asignados</h2>
          
          @if (donutChartConfig() && statusSummary()!.summary.total_orders > 0) {
            <div class="donut-chart-container">
              <div class="chart-center-label">
                <div class="center-value">{{ statusSummary()!.summary.total_orders }}</div>
                <div class="center-label" i18n="@@reports.seller.ordersLabel">pedidos</div>
              </div>
              <canvas 
                baseChart
                [type]="donutChartConfig()!.type"
                [data]="donutChartConfig()!.data"
                [options]="donutChartConfig()!.options">
              </canvas>
            </div>
          } @else {
            <div class="no-data">
              <p i18n="@@reports.seller.noOrders">No hay pedidos registrados para este vendedor</p>
            </div>
          }
        </div>

        <!-- Earnings Table -->
        <div class="table-card earnings-table-card">
          <h2 class="card-title" i18n="@@reports.seller.earningsTitle">Ganancias por cliente asignado</h2>
          
          @if (clientsSummary() && clientsSummary()!.clients.length > 0) {            
            <table mat-table [dataSource]="paginatedClients" class="clients-table">
              <!-- Client Name Column -->
              <ng-container matColumnDef="client_name">
                <th mat-header-cell *matHeaderCellDef><span i18n="@@reports.seller.clientHeader">CLIENTE</span></th>
                <td mat-cell *matCellDef="let client">{{ client.client_name }}</td>
              </ng-container>

              <!-- Total Amount Column -->
              <ng-container matColumnDef="total_amount">
                <th mat-header-cell *matHeaderCellDef><span i18n="@@reports.seller.earningsHeader">GANANCIA (COP)</span></th>
                <td mat-cell *matCellDef="let client">{{ formatCurrency(client.total_amount) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
            </table>

            <!-- Pagination -->
            @if (clientsSummary()!.pagination.total_pages > 1) {
              <div class="custom-pagination">
                <div class="pagination-info">
                  <ng-container i18n="@@reports.seller.paginationInfo">Mostrando {{ ((currentPage() - 1) * pageSize()) + 1 }} al
                  {{ Math.min(currentPage() * pageSize(), clientsSummary()!.pagination.total) }}
                  de {{ clientsSummary()!.pagination.total }} registros</ng-container>
                </div>

                <div class="pagination-buttons">
                  <button
                    class="pagination-btn"
                    (click)="previousPage()"
                    [disabled]="currentPage() === 1"
                    i18n-aria-label="@@reports.seller.prevPageAria" aria-label="Página anterior">
                    <span i18n="@@reports.seller.previous">Anterior</span>
                  </button>

                  @for (page of pageNumbers; track page) { @if (page > 0) {
                    <button
                      class="pagination-btn"
                      [class.active]="page === currentPage()"
                      (click)="goToPage(page)"
                      [attr.aria-label]="'Ir a página ' + page"
                      [attr.aria-current]="page === currentPage() ? 'page' : null">
                      {{ page }}
                    </button>
                  } @else {
                    <span class="pagination-ellipsis" aria-hidden="true">&hellip;</span>
                  } }

                  <button
                    class="pagination-btn"
                    (click)="nextPage()"
                    [disabled]="currentPage() === totalPages"
                    i18n-aria-label="@@reports.seller.nextPageAria" aria-label="Página siguiente">
                    <span i18n="@@reports.seller.next">Siguiente</span>
                  </button>
                </div>
              </div>
            }
          } @else {
            <div class="no-data">
              <p i18n="@@reports.seller.noClients">No hay clientes asignados a este vendedor</p>
            </div>
          }
        </div>
      </div>

      <!-- Bottom Row: Line Chart (Full Width) -->
      <div class="bottom-row">
        <div class="chart-card line-chart-card">
          <h2 class="card-title" i18n="@@reports.seller.totalSalesTitle">Ventas totales del último año (COP)</h2>
          
          @if (lineChartConfig() && monthlySummary()!.summary.total_orders > 0) {
            <div class="line-chart-container">
              <canvas 
                baseChart
                [type]="lineChartConfig()!.type"
                [data]="lineChartConfig()!.data"
                [options]="lineChartConfig()!.options">
              </canvas>
            </div>
          } @else {
            <div class="no-data">
              <p i18n="@@reports.seller.noSalesData">No hay datos de ventas para mostrar</p>
            </div>
          }
        </div>
      </div>
    }

    <!-- Empty State (when no seller selected) -->
    @if (!selectedSellerId() && !loadingReports()) {
      <div class="empty-state">
        <mat-icon class="empty-icon">assessment</mat-icon>
        <p i18n="@@reports.seller.selectSeller">Seleccione un vendedor para ver su informe de desempeño</p>
      </div>
    }
  </div>
</div>
