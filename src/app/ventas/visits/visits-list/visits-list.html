<div class="visits-container">
  <div class="header">
    <h1 i18n="@@visits.title">Visitas</h1>
    <div class="breadcrumb">
      <span class="breadcrumb-link" i18n="@@visits.breadcrumbVentas">Ventas</span>
      <span class="breadcrumb-separator">-</span>
      <span class="breadcrumb-current" i18n="@@visits.breadcrumbVisitas">Visitas</span>
    </div>
  </div>

  <div class="table-container">
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p i18n="@@visits.loading">Cargando visitas...</p>
      </div>
    } @else {
      <table mat-table [dataSource]="videos()" class="visits-table" data-cy="visits-table">
        <!-- ID Visita Column -->
        <ng-container matColumnDef="id_visita">
          <th mat-header-cell *matHeaderCellDef>
            <span i18n="@@visits.id">ID VISITA</span>
            <div class="filter-header">
              <input
                type="text"
                class="filter-input"
                i18n-placeholder="@@visits.searchId"
                placeholder="Buscar ID"
                data-cy="filter-id"
                [(ngModel)]="searchId"
                (input)="onSearchIdChange($event)" />
            </div>
          </th>
          <td mat-cell *matCellDef="let video">{{ video.visit_id }}</td>
        </ng-container>

        <!-- Cliente Column -->
        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef>
            <span i18n="@@visits.client">CLIENTE</span>
            <div class="filter-header">
              <input
                type="text"
                class="filter-input"
                i18n-placeholder="@@visits.searchClient"
                placeholder="Buscar cliente"
                data-cy="filter-client"
                [(ngModel)]="searchClient"
                (input)="onSearchClientChange($event)" />
            </div>
          </th>
          <td mat-cell *matCellDef="let video">{{ video.name }}</td>
        </ng-container>

        <!-- Estado Column -->
          
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>
            <span i18n="@@visits.status">ESTADO</span>
            <div class="filter-header">
              <select
                class="filter-input filter-select"
                i18n-aria-label="@@visits.statusFilterAria" aria-label="Filtrar por estado"
                [(ngModel)]="searchStatus"
                (ngModelChange)="onSearchStatusChange($event)">
                <option value="" i18n="@@visits.all">Todos</option>
                <option value="Cargado" i18n="@@visits.uploaded">Cargado</option>
                <option value="Procesado" i18n="@@visits.processed">Procesado</option>                
              </select>
            </div>
          </th>
          <td mat-cell *matCellDef="let video">
            <span class="status-badge" [class.status-completed]="video.file_status === 'Procesado'">
              {{ video.file_status || getInProgressText() }}
            </span>
          </td>
        </ng-container>        <!-- Hallazgos Column -->
        <ng-container matColumnDef="hallazgos">
          <th mat-header-cell *matHeaderCellDef>
            <span i18n="@@visits.findings">HALLAZGOS</span>
            <div class="filter-header">
              <input
                type="text"
                class="filter-input"
                i18n-placeholder="@@visits.searchFindings"
                placeholder="Buscar hallazgos"
                data-cy="filter-findings"
                [(ngModel)]="searchFindings"
                (input)="onSearchFindingsChange($event)" />
            </div>
          </th>
          <td mat-cell *matCellDef="let video">{{ video.find || getFindingsText() }}</td>
        </ng-container>

        <!-- Evidencia Column -->
        <ng-container matColumnDef="evidencia">
          <th mat-header-cell *matHeaderCellDef><span i18n="@@visits.evidence">EVIDENCIA</span></th>
          <td mat-cell *matCellDef="let video">
            <button 
              mat-icon-button 
              data-cy="evidence-btn"
              [disabled]="!isVideoAvailable(video)"
              [matTooltip]="getTooltipText(video)"
              i18n-aria-label="@@visits.evidenceActionAria" aria-label="Ver evidencia"
              (click)="openVideoDialog(video)">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <tr class="mat-row no-data-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            <span i18n="@@visits.noData">No se encontraron visitas</span>
          </td>
        </tr>
      </table>

      <!-- Custom Pagination -->
      <div class="custom-pagination" *ngIf="pagination().total > 0" data-cy="pagination">
        <div class="pagination-info">
          <ng-container i18n="@@visits.paginationInfo">Mostrando {{ (pagination().page - 1) * pagination().per_page + 1 }} a {{ Math.min(pagination().page * pagination().per_page, pagination().total) }} de {{ pagination().total }} registros</ng-container>
        </div>

        <div class="pagination-buttons">
          <button
            class="pagination-btn"
            data-cy="prev-page"
            (click)="previousPage()"
            [disabled]="pagination().page === 1"
            i18n-aria-label="@@visits.previousPage"
            aria-label="Página anterior">
            <span i18n="@@visits.previous">Anterior</span>
          </button>

          @for (page of pageNumbers; track page) {
            @if (page > 0) {
              <button
                class="pagination-btn"
                data-cy="page-btn"
                [class.active]="page === pagination().page"
                (click)="goToPage(page)"
                [attr.aria-label]="'Ir a página ' + page"
                [attr.aria-current]="page === pagination().page ? 'page' : null">
                {{ page }}
              </button>
            } @else {
              <span class="pagination-ellipsis" aria-hidden="true">&hellip;</span>
            }
          }

          <button
            class="pagination-btn"
            data-cy="next-page"
            (click)="nextPage()"
            [disabled]="pagination().page === pagination().total_pages"
            i18n-aria-label="@@visits.nextPage"
            aria-label="Página siguiente">
            <span i18n="@@visits.next">Siguiente</span>
          </button>
        </div>
      </div>
    }
  </div>
</div>
