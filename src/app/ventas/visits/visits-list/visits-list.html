<div class="visits-container">
  <div class="header">
    <h1>Visitas</h1>
    <div class="breadcrumb">
      <span class="breadcrumb-link">Ventas</span>
      <span class="breadcrumb-separator">-</span>
      <span class="breadcrumb-current">Visitas</span>
    </div>
  </div>

  <div class="table-container">
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando visitas...</p>
      </div>
    } @else {
      <table mat-table [dataSource]="videos()" class="visits-table" data-cy="visits-table">
        <!-- ID Visita Column -->
        <ng-container matColumnDef="id_visita">
          <th mat-header-cell *matHeaderCellDef>
            ID VISITA
            <div class="filter-header">
              <input
                type="text"
                class="filter-input"
                placeholder="Buscar ID"
                data-cy="filter-id"
                [(ngModel)]="searchId"
                (input)="onSearchIdChange($event)" />
            </div>
          </th>
          <td mat-cell *matCellDef="let video">{{ video.visit_id }}</td>
        </ng-container>

        <!-- Cliente Column -->
        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef>
            CLIENTE
            <div class="filter-header">
              <input
                type="text"
                class="filter-input"
                placeholder="Buscar cliente"
                data-cy="filter-client"
                [(ngModel)]="searchClient"
                (input)="onSearchClientChange($event)" />
            </div>
          </th>
          <td mat-cell *matCellDef="let video">{{ video.name }}</td>
        </ng-container>

        <!-- Estado Column -->
          
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>
            ROL
            <div class="filter-header">
              <select
                class="filter-input filter-select"
                [(ngModel)]="searchStatus"
                (ngModelChange)="onSearchStatusChange($event)">
                <option value="">Todos</option>
                <option value="Cargado">Cargado</option>
                <option value="Procesado">Procesado</option>                
              </select>
            </div>
          </th>
          <td mat-cell *matCellDef="let video">
                <span class="status-badge" [class.status-completed]="video.file_status === 'Procesado'">
                {{ video.file_status || 'En curso' }}
                </span>
            </td>
        </ng-container>        

        <!-- Hallazgos Column -->
        <ng-container matColumnDef="hallazgos">
          <th mat-header-cell *matHeaderCellDef>
            HALLAZGOS
            <div class="filter-header">
              <input
                type="text"
                class="filter-input"
                placeholder="Buscar hallazgos"
                data-cy="filter-findings"
                [(ngModel)]="searchFindings"
                (input)="onSearchFindingsChange($event)" />
            </div>
          </th>
          <td mat-cell *matCellDef="let video">{{ video.find || 'Hallazgos' }}</td>
        </ng-container>

        <!-- Evidencia Column -->
        <ng-container matColumnDef="evidencia">
          <th mat-header-cell *matHeaderCellDef>EVIDENCIA</th>
          <td mat-cell *matCellDef="let video">
            <button 
              mat-icon-button 
              data-cy="evidence-btn"
              [disabled]="!isVideoAvailable(video)"
              [matTooltip]="isVideoAvailable(video) ? 'Ver video' : 'Video no disponible'"
              (click)="openVideoDialog(video)">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <tr class="mat-row no-data-row" *matNoDataRow>
          <td class="mat-cell" [attr.colspan]="displayedColumns.length">
            No se encontraron visitas
          </td>
        </tr>
      </table>

      <!-- Custom Pagination -->
      <div class="custom-pagination" *ngIf="pagination().total > 0" data-cy="pagination">
        <div class="pagination-info">
          Mostrando {{ (pagination().page - 1) * pagination().per_page + 1 }}
          al {{ Math.min(pagination().page * pagination().per_page, pagination().total) }}
          de {{ pagination().total }} registros
        </div>

        <div class="pagination-buttons">
          <button
            class="pagination-btn"
            data-cy="prev-page"
            (click)="previousPage()"
            [disabled]="pagination().page === 1"
            aria-label="Página anterior">
            Anterior
          </button>

          @for (page of pageNumbers; track page) {
            @if (page > 0) {
              <button
                class="pagination-btn"
                data-cy="page-btn"
                [class.active]="page === pagination().page"
                (click)="goToPage(page)"
                [attr.aria-label]="'Ir a página ' + page"
                [attr.aria-current]="page === pagination().page ? 'page' : null">
                {{ page }}
              </button>
            } @else {
              <span class="pagination-ellipsis" aria-hidden="true">&hellip;</span>
            }
          }

          <button
            class="pagination-btn"
            data-cy="next-page"
            (click)="nextPage()"
            [disabled]="pagination().page === pagination().total_pages"
            aria-label="Página siguiente">
            Siguiente
          </button>
        </div>
      </div>
    }
  </div>
</div>
