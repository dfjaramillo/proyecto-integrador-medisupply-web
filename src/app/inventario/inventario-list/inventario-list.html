<div class="inventario-container">
  <div class="header">
    <h1>Inventario</h1>
    <div class="breadcrumb">
      <span class="breadcrumb-link">Inventario</span>
    </div>
  </div>

  <div class="table-container">
    <div class="action-bar">
      @if (canCreateProducto()) {
      <button
        mat-raised-button
        class="create-btn"
        (click)="openCreateProductoDialog()"
        aria-label="Crear nuevo producto"
      >
        Crear producto
      </button>
      <button
        mat-raised-button
        class="upload-btn"
        (click)="openCargueMasivoDialog()"
        aria-label="Cargue masivo de productos"
      >
        Cargue masivo
      </button>
      }
    </div>

    @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando productos...</p>
    </div>
    } @else {

    <table mat-table [dataSource]="paginatedProductos" class="productos-table">
      <!-- SKU Column -->
      <ng-container matColumnDef="sku">
        <th mat-header-cell *matHeaderCellDef>
          SKU
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              placeholder="Buscar SKU"
              [ngModel]="skuFilter()"
              (input)="onSkuFilterChange($event)"
              aria-label="Filtrar por SKU"
              minlength="3" />
          </div>
        </th>
        <td mat-cell *matCellDef="let producto">{{ producto.sku }}</td>
      </ng-container>

      <!-- Nombre Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>
          NOMBRE
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              placeholder="Buscar Nombre"
              [ngModel]="nombreFilter()"
              (input)="onNombreFilterChange($event)"
              aria-label="Filtrar por nombre"
              minlength="3" />
          </div>
        </th>
        <td mat-cell *matCellDef="let producto">{{ producto.name }}</td>
      </ng-container>

      <!-- Fecha de Vencimiento Column -->
      <ng-container matColumnDef="expiration_date">
          <th mat-header-cell *matHeaderCellDef>
            FECHA DE VENCIMIENTO
            <div class="filter-header">
              <input
                type="date"
                class="filter-input"
                placeholder="Buscar Fecha"
                [ngModel]="selectedDate"
                (ngModelChange)="onDateChange($event)"
                aria-label="Filtrar por fecha de vencimiento" />
            </div>
        </th>
        <td mat-cell *matCellDef="let producto">
          {{ formatDate(producto.expiration_date) }}
        </td>
      </ng-container>

      <!-- Cantidad Disponible Column -->
      <ng-container matColumnDef="quantity">
        <th mat-header-cell *matHeaderCellDef>
          CANTIDAD DISPONIBLE
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              placeholder="Buscar Cantidad"
              [ngModel]="cantidadFilter()"
              (input)="onCantidadFilterChange($event)"
              aria-label="Filtrar por cantidad"
              minlength="3" />
          </div>
        </th>
        <td mat-cell *matCellDef="let producto">
          {{ producto.quantity }} unidades
        </td>
      </ng-container>

      <!-- Precio C/U Column -->
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>
          PRECIO C/U
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              placeholder="Buscar Precio"
              [ngModel]="precioFilter()"
              (input)="onPrecioFilterChange($event)"
              aria-label="Filtrar por precio"
              minlength="3" />
          </div>
        </th>
        <td mat-cell *matCellDef="let producto">
          {{ formatPrice(producto.price) }}
        </td>
      </ng-container>

      <!-- Ubicación Column -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>
          UBICACIÓN
          <div class="filter-header">
            <input
              type="text"
              class="filter-input"
              placeholder="Buscar Ubicación"
              [ngModel]="ubicacionFilter()"
              (input)="onUbicacionFilterChange($event)"
              aria-label="Filtrar por ubicación"
              minlength="3" />
          </div>
        </th>
        <td mat-cell *matCellDef="let producto">{{ producto.location }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

      <!-- No data row -->
      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" [attr.colspan]="displayedColumns.length">
          No se encontraron productos que coincidan con los criterios de
          búsqueda
        </td>
      </tr>
    </table>

    <!-- Pagination -->
    @if (pagination() && pagination()!.total_pages > 1) {
    <div class="custom-pagination">
      <div class="pagination-info">
        Mostrando {{ (pagination()!.page - 1) * pagination()!.per_page + 1 }} al
        {{
          Math.min(
            pagination()!.page * pagination()!.per_page,
            pagination()!.total
          )
        }}
        de {{ pagination()!.total }} registros
      </div>

      <div class="pagination-buttons">
        <button
          class="pagination-btn"
          (click)="goToPage(currentPage - 1)"
          [disabled]="!pagination()?.has_prev"
          aria-label="Página anterior"
        >
          Anterior
        </button>

        @for (page of pageNumbers; track page) { @if (page > 0) {
        <button
          class="pagination-btn"
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
          [attr.aria-label]="'Ir a página ' + page"
          [attr.aria-current]="page === currentPage ? 'page' : null"
        >
          {{ page }}
        </button>
        } @else {
        <span class="pagination-ellipsis" aria-hidden="true">...</span>
        } }

        <button
          class="pagination-btn"
          (click)="goToPage(currentPage + 1)"
          [disabled]="!pagination()?.has_next"
          aria-label="Página siguiente"
        >
          Siguiente
        </button>
      </div>
    </div>
    }

    <!-- Historial de Cargues Masivos -->
    @if(canCreateProducto()) {
    <div class="history-section">
      <app-historial-cargue-list></app-historial-cargue-list>
    </div>
    } }
  </div>
</div>
